<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OnsiteCat - greentheme</title>
<style>
  :root{
    --bg-1: #f5f7f3;
    --bg-2: #e0f2f1;
    --accent-1: #56ab2f;
    --accent-2: #a8e063;
    --card: #eaf3e1;
    --muted: #8ca68f;
    --text: #2e462d;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg,var(--bg-1),var(--bg-2));
    color:var(--text);
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:20px;
    gap:6px;
  }
  h1#app-name{
    font-size:2.6rem;
    font-weight:800;
    background: linear-gradient(90deg,var(--accent-1),var(--accent-2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    padding:14px 36px;
    margin:0;
    user-select:none;
    letter-spacing:4px;
    filter: drop-shadow(2px 2px 3px rgba(0,75,0,0.25));
    width:100%;
    max-width:1100px;
    text-align:center;
  }

  .controls {
    width:100%;
    max-width:1100px;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:flex-start;
    margin-top:8px;
  }

  #upload-label, #categorize-button, .small-btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    cursor:pointer;
    background-color:#a8d5a2;
    border:2px solid #4caf50;
    border-radius:12px;
    padding:10px 18px;
    font-size:1rem;
    font-weight:700;
    color:#1b3e20;
    transition:all .18s ease;
    box-shadow: 0 6px 18px rgba(72,143,67,0.16);
    user-select:none;
  }
  .small-btn{ padding:8px 12px; font-weight:700; background:#fff; border:1px solid #4caf50; color:var(--text) }

  #upload-label:hover, #categorize-button:not(:disabled):hover { background:#8cc77e; transform:translateY(-1px) }
  #upload-icon { width:22px; height:22px; fill:#1b3e20 }

  #csv-input{ display:none }

  #status{
    width:100%;
    max-width:1100px;
    font-weight:600;
    color:#2d6b2e;
    min-height:1.2em;
    margin-top:6px;
  }

  .table-container{
    width:100%;
    max-width:1100px;
    background:var(--card);
    border-radius:12px;
    box-shadow:0 8px 26px rgba(56,112,52,0.12);
    padding:14px;
    margin-top:12px;
  }

  .table-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:10px;
  }

  table{
    width:100%;
    border-collapse:collapse;
    font-family:Arial, sans-serif;
    table-layout:fixed; /* fixed-layout for consistent columns */
  }
  thead th{
    text-align:left;
    padding:10px 12px;
    background:#cbe3a1;
    color:var(--text);
    font-weight:700;
    border-bottom:1px solid #d3d8cc;
  }
  tbody td{
    padding:10px 12px;
    border-bottom:1px solid #d3d8cc;
    color:#355a25;
    vertical-align:middle;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }

  /* Column widths (adjust as required) */
  th.col-id, td.col-id{ width:8%; min-width:70px; }
  th.col-desc, td.col-desc{ width:38%; } /* description gets majority */
  th.col-amt, td.col-amt{ width:10%; min-width:80px; text-align:right; }
  th.col-cat, td.col-cat{ width:12%; min-width:100px; }
  th.col-expl, td.col-expl{ width:10%; text-align:center; }
  th.col-correct, td.col-correct{ width:12%; min-width:120px; }

  /* allow description to wrap on smaller screens but keep single-line in desktop */
  td.col-desc { white-space: nowrap; }
  @media (max-width:900px){
    td.col-desc{ white-space:normal; word-wrap:break-word; }
    table{ font-size:0.95rem }
  }

  .info-button{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:34px;
    height:34px;
    border-radius:50%;
    border:1px solid rgba(27,62,32,0.12);
    background:linear-gradient(#fff,#e9f4ea);
    box-shadow:0 2px 6px rgba(56,112,52,0.12);
    cursor:pointer;
  }
  .info-button svg{ width:16px; height:16px; fill:#1b3e20 }

  select.category-edit{ padding:6px 10px; font-size:0.95rem; width:100%; max-width:220px; }

  #explanation-popup{
    position: absolute;
    max-width:420px;
    padding:12px 14px;
    background:#d8e9d3;
    border-radius:10px;
    box-shadow:0 8px 30px rgba(56,112,52,0.25);
    color:#1b3e20;
    font-weight:600;
    user-select:none;
    display:none;
    z-index:9000;
  }

  /* small helper for right aligned money */
  .money { text-align:right; font-variant-numeric: tabular-nums; }

</style>
</head>
<body>

<h1 id="app-name">OnsiteCat</h1>

<div class="controls">
  <label id="upload-label" for="csv-input" title="Upload transactions CSV file">
    <svg id="upload-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 2C8.13 2 5 5.13 5 9c0 3.27 2.6 5.97 5.84 6V18H9v2h6v-2h-1.83v-3c3.22-.15 6-2.82 6-6 0-3.87-3.13-7-7-7zM12 14c-2.22 0-4-1.78-4-4s1.78-4 4-4 4 1.78 4 4-1.78 4-4 4z"/>
    </svg>
    Upload transactions file
  </label>
  <input id="csv-input" type="file" accept=".csv" />

  <button id="categorize-button" class="small-btn" disabled>Categorize</button>

  <div style="margin-left:auto; display:flex; gap:8px;">
    <button id="download-results" class="small-btn">Download results</button>
    <button id="choose-updates-file" class="small-btn" title="Choose updates file (fallback)">Choose updates file</button>
  </div>
</div>

<div id="status" role="status" aria-live="polite"></div>

<div class="table-container" id="table-container" style="display:none;">
  <div class="table-header">
    <strong>Results</strong>
    <div style="font-size:0.95rem; color:var(--muted)">Note: Category = model tag. Correct Category = your edit.</div>
  </div>

  <table id="results-table" role="table" aria-label="Categorization results">
    <thead>
      <tr>
        <th class="col-id">ID</th>
        <th class="col-desc">Description</th>
        <th class="col-amt">Amount</th>
        <th class="col-cat">Category</th>
        <th class="col-expl">Explanation</th>
        <th class="col-correct">Correct Category</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="explanation-popup" role="dialog" aria-modal="false"></div>

<script>
/* ---------------------------
  Configuration & state
---------------------------- */
const CATEGORIZE_URL = 'http://127.0.0.1:5000/categorize';
const UPDATE_URL = 'http://127.0.0.1:5000/update_category'; // server saves locally at its end (default path)
const categories = ['Education',
 'Bills/Utilities',
 'Loan/EMI Payments/Asset Payments',
 'Home/Living',
 'Insurance',
 'Personal Care/Wellness',
 'Groceries/Essentials',
 'Shopping',
 'Entertainment/Subscriptions',
 'Food/Dining',
 'Income',
 'Travel/Transport',
 'Transfers',
 'Health/Medical',
 'Fees/Charges',
 'Refunds',
 'uncategorized'];

const input = document.getElementById('csv-input');
const categorizeBtn = document.getElementById('categorize-button');
const status = document.getElementById('status');
const tableContainer = document.getElementById('table-container');
const tbody = document.querySelector('#results-table tbody');
const explanationPopup = document.getElementById('explanation-popup');
const downloadBtn = document.getElementById('download-results');
const chooseUpdatesBtn = document.getElementById('choose-updates-file');

let currentFile = null;
let sessionUpdates = []; // fallback session buffer
let updatesFileHandle = null;
let updatesFileChosenThisSession = false;

/* ---------------------------
  UI: file input & categorize
---------------------------- */
input.addEventListener('change', () => {
  if (!input.files || input.files.length === 0) {
    currentFile = null;
    categorizeBtn.disabled = true;
    tableContainer.style.display = 'none';
    status.textContent = '';
    return;
  }
  currentFile = input.files[0];
  categorizeBtn.disabled = false;
  status.textContent = 'Ready: ' + currentFile.name;
  tableContainer.style.display = 'none';
});

categorizeBtn.addEventListener('click', async () => {
  if (!currentFile) return;
  status.textContent = 'Categorizing...';
  categorizeBtn.disabled = true;
  try {
    const fd = new FormData();
    fd.append('file', currentFile);
    const res = await fetch(CATEGORIZE_URL, { method:'POST', body: fd });
    if (!res.ok) throw new Error('Server returned ' + res.status);
    const data = await res.json();
    populateTable(data);
    tableContainer.style.display = 'block';
    status.textContent = 'Categorization complete.';
  } catch (err) {
    console.error(err);
    status.textContent = 'Error: ' + (err.message || err);
    tableContainer.style.display = 'none';
  } finally {
    categorizeBtn.disabled = false;
    setTimeout(()=>status.textContent='', 1800);
  }
});

/* ---------------------------
  populate table
---------------------------- */
function populateTable(rows){
  tbody.innerHTML = '';
  rows.forEach((row, idx) => {
    const tr = document.createElement('tr');
    tr.dataset.rowIndex = String(idx);
    try { tr.dataset.row = JSON.stringify(row); } catch(e){ tr.dataset.row = '{}' }

    // ID
    const idCell = cell(row.transaction_id || row.id || `row_${idx}`, 'col-id');
    tr.appendChild(idCell);

    // Description
    const descCell = cell(row.description || '', 'col-desc');
    tr.appendChild(descCell);

    // Amount (right aligned)
    const amtCell = cell(row.amount || '', 'col-amt');
    amtCell.classList.add('money');
    tr.appendChild(amtCell);

    // Category (model's predicted tag) — DO NOT change this when user edits
    const catCell = cell(row.category || '', 'col-cat');
    tr.appendChild(catCell);

    // Explanation icon
    const explCell = document.createElement('td');
    explCell.className = 'col-expl';
    const infoBtn = document.createElement('button');
    infoBtn.type = 'button';
    infoBtn.className = 'info-button';
    infoBtn.title = 'Show explanation';
    infoBtn.dataset.rowIndex = String(idx);
    infoBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M11 7h2v2h-2V7zm1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm1.07-7.75l-.9.92C12.45 13.9 12 14.5 12 16h-2v-.5c0-1 .45-1.8 1.17-2.55l1.24-1.27c.37-.36.59-.86.59-1.38 0-1.1-.9-2-2-2s-2 .9-2 2H7c0-2.76 2.24-5 5-5s5 2.24 5 5c0 .88-.36 1.68-.93 2.25z"/>
    </svg>`;
    explCell.appendChild(infoBtn);
    tr.appendChild(explCell);

    // Correct Category (editable) — DO NOT overwrite the 'Category' column
    const editCell = document.createElement('td');
    editCell.className = 'col-correct';
    const select = document.createElement('select');
    select.className = 'category-edit';
    select.dataset.rowIndex = String(idx);
    categories.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      // default to predicted if matches, else first category
      if (c === row.category) opt.selected = true;
      select.appendChild(opt);
    });
    select.addEventListener('change', () => onCorrectCategoryChange(select, tr));
    editCell.appendChild(select);
    tr.appendChild(editCell);

    tbody.appendChild(tr);
  });
}

/* helper to make a td */
function cell(text, cls='') {
  const td = document.createElement('td');
  td.className = cls;
  td.textContent = text;
  return td;
}

/* ---------------------------
  explanation: delegation & robust positioning
---------------------------- */
tbody.addEventListener('click', (e) => {
  const btn = e.target.closest('.info-button');
  if (!btn) return;
  e.stopPropagation();
  const idx = btn.dataset.rowIndex;
  const tr = tbody.querySelector(`tr[data-row-index="${CSS.escape(idx)}"]`);
  const row = safeParse(tr?.dataset?.row);
  const explanation = row.explanation || `The transaction at ${row.merchant || 'merchant'} is related to ${row.context_feature || 'relevant context'}.`;
  showExplanation(explanation, btn);
});

function showExplanation(text, anchorEl){
  explanationPopup.textContent = text;
  explanationPopup.style.display = 'block';
  // ensure popup rendered size is measured
  explanationPopup.style.left = '-9999px';
  explanationPopup.style.top = '-9999px';

  // compute position with clamping; if it would be offscreen, scroll to make it visible
  const rect = anchorEl.getBoundingClientRect();
  const popupRect = explanationPopup.getBoundingClientRect();
  const popupW = Math.min(420, window.innerWidth - 24);
  explanationPopup.style.maxWidth = popupW + 'px';

  // prefer below the anchor
  let top = rect.bottom + window.scrollY + 8;
  let left = rect.left + window.scrollX;

  // clamp left to viewport
  if (left + popupW + 12 > window.scrollX + window.innerWidth) {
    left = window.scrollX + window.innerWidth - popupW - 12;
  }
  if (left < window.scrollX + 8) left = window.scrollX + 8;

  // place below; if it overflows bottom, try above; if still overflows, scroll to reveal
  const estimatedHeight = explanationPopup.offsetHeight || 120;
  if (top + estimatedHeight > window.scrollY + window.innerHeight - 8) {
    // show above
    top = rect.top + window.scrollY - estimatedHeight - 8;
    // if still off top, scroll so anchor is centered and recompute top
    if (top < window.scrollY + 8) {
      const targetScroll = Math.max(0, rect.top + window.scrollY - (window.innerHeight / 2));
      window.scrollTo({ top: targetScroll, behavior: 'smooth' });
      // recompute coordinates after scroll (rough)
      setTimeout(() => showExplanation(text, anchorEl), 260);
      return;
    }
  }

  explanationPopup.style.left = left + 'px';
  explanationPopup.style.top = top + 'px';

  // auto-hide after 5s
  clearTimeout(explanationPopup._hideTimeout);
  explanationPopup._hideTimeout = setTimeout(() => {
    explanationPopup.style.display = 'none';
  }, 5000);
}

// clicking outside hides popup
document.addEventListener('click', (e) => {
  if (!explanationPopup.contains(e.target) && !e.target.closest('.info-button')) {
    explanationPopup.style.display = 'none';
  }
});
explanationPopup.addEventListener('click', (e)=> e.stopPropagation());

/* ---------------------------
  Handle correct category change: send to server + fallback append
  - include merchant & context_feature in payload
---------------------------- */
async function onCorrectCategoryChange(select, tr){
  const newCategory = select.value;
  const raw = safeParse(tr.dataset.row);
  const tds = tr.querySelectorAll('td');
  const id = tds[0]?.textContent || (raw.transaction_id||raw.id||tr.dataset.rowIndex);
  const description = tds[1]?.textContent || raw.description || '';
  const amount = tds[2]?.textContent || raw.amount || '';
  const old_category = raw.category || '';
  const merchant = raw.extracted_merchant_name || '';
  const context_feature = raw.context_feature || '';
  const explanation = raw.explanation || '';

  // IMPORTANT: do NOT modify the Category cell (td at index 3). Only the select reflects the correction.
  // Prepare payload to send to server (server will save to default path)
  const payload = {
    transaction_id: id,
    description,
    amount,
    old_category,
    new_category: newCategory,
    merchant,
    context_feature,
    explanation,
    timestamp: new Date().toISOString()
  };

  // optimistic UI: mark status
  select.disabled = true;
  status.textContent = `Saving update for ${id} → ${newCategory}...`;

  // try server
  try {
    const res = await fetch(UPDATE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('Server returned ' + res.status);
    status.textContent = `Saved to server: ${id} → ${newCategory}`;
  } catch (err) {
    // server failed — fallback behavior:
    status.textContent = `Server unavailable — falling back to local file/session.`;
    await fallbackSave(payload);
  } finally {
    select.disabled = false;
    // remember edit in session buffer so download includes it
    rememberLocalEdit(id, payload);
    setTimeout(()=> status.textContent = '', 1600);
  }
}

/* ---------------------------
  fallbackSave:
   - If File System Access API available, prompt once to choose a file,
     then append subsequent edits to that same file in-session.
   - If FS API not available or user cancels, store in sessionUpdates only.
---------------------------- */
async function fallbackSave(payload){
  // If file handle exists, append directly
  if (updatesFileHandle){
    try{
      await appendRowsToFileSystem([payload]);
      status.textContent = 'Appended to chosen updates file.';
      return;
    } catch(e){
      console.warn('append failed', e);
    }
  }

  // If FS API available and we haven't asked yet in this session, try to prompt
  if ('showSaveFilePicker' in window && !updatesFileChosenThisSession){
    try{
      updatesFileChosenThisSession = true;
      updatesFileHandle = await window.showSaveFilePicker({
        suggestedName: 'onsitecat_updates.csv',
        types: [{ description:'CSV', accept:{'text/csv':['.csv']} }]
      });
      await appendRowsToFileSystem([payload]);
      status.textContent = 'Chosen file and appended update.';
      return;
    } catch (err){
      // user dismissed or denied permission; fall back to session buffer
      console.info('User did not choose file or FS API aborted.', err);
    }
  }

  // Last fallback: keep in-memory for the session
  sessionUpdates.push(payload);
  status.textContent = 'Saved update to session buffer.';
}

/* appendRowsToFileSystem: File System Access API append with header handling */
async function appendRowsToFileSystem(rows){
  if (!updatesFileHandle) throw new Error('No file handle');
  if (!rows || rows.length===0) return;
  // create CSV lines
  const header = ['transaction_id','description','amount','old_category','new_category','merchant','context_feature','explanation','timestamp'].join(',');
  const lines = rows.map(r => [
    r.transaction_id||'', r.description||'', r.amount||'', r.old_category||'', r.new_category||'',
    r.merchant||'', r.context_feature||'', r.explanation||'', r.timestamp||''
  ].map(escapeCell).join(',')).join('\r\n') + '\r\n';

  const file = await updatesFileHandle.getFile();
  const fileSize = file.size;
  const headerPrefix = fileSize===0 ? header + '\r\n' : '';
  const writable = await updatesFileHandle.createWritable({ keepExistingData: true });
  await writable.write({ type:'write', position: fileSize, data: headerPrefix + lines });
  await writable.close();
}

/* escape for CSV */
function escapeCell(v){
  if (v === null || v === undefined) return '';
  const s = String(v);
  if (s.includes('"') || s.includes(',') || s.includes('\n') || s.includes('\r')) {
    return `"${s.replace(/"/g,'""')}"`;
  }
  return s;
}

/* ---------------------------
  rememberLocalEdit: keep map in memory so Download results includes user edits
---------------------------- */
const localEdits = new Map(); // id -> payload (for download)

function rememberLocalEdit(id, payload){
  localEdits.set(id, payload);
}

/* ---------------------------
  Choose updates file button (explicit)
---------------------------- */
chooseUpdatesBtn.addEventListener('click', async () => {
  if (!('showSaveFilePicker' in window)) {
    status.textContent = 'File System Access API not available in this browser.';
    return;
  }
  try {
    updatesFileHandle = await window.showSaveFilePicker({
      suggestedName: 'onsitecat_updates.csv',
      types: [{ description:'CSV', accept:{'text/csv':['.csv']} }]
    });
    updatesFileChosenThisSession = true;
    status.textContent = 'Chosen updates file: ' + (updatesFileHandle.name || 'onsitecat_updates.csv');
    // if we have session buffer, append now
    if (sessionUpdates.length > 0) {
      await appendRowsToFileSystem(sessionUpdates.splice(0));
      status.textContent = 'Appended previous session updates to chosen file.';
    }
  } catch (err) {
    status.textContent = 'No file chosen or permission denied.';
  } finally {
    setTimeout(()=> status.textContent='', 1600);
  }
});

/* ---------------------------
  Download results button:
   - Download current result table
   - Include user's corrected category from selects
   - Exclude merchant & context_feature per your request
---------------------------- */
downloadBtn.addEventListener('click', () => {
  const trs = Array.from(tbody.querySelectorAll('tr'));
  if (!trs.length) {
    status.textContent = 'No data to download.';
    setTimeout(()=>status.textContent='',1400);
    return;
  }

  const header = ['transaction_id','description','amount','original_category','corrected_category','explanation','edit_timestamp'];
  const escapeCellLocal = (v) => {
    if (v === null || v === undefined) return '';
    const s = String(v);
    if (s.includes('"') || s.includes(',') || s.includes('\n') || s.includes('\r')) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };

  const lines = [header.join(',')];

  trs.forEach(tr => {
    const raw = safeParse(tr.dataset.row);
    const tds = tr.querySelectorAll('td');
    const id = tds[0]?.textContent || raw.transaction_id || raw.id || tr.dataset.rowIndex;
    const description = tds[1]?.textContent || raw.description || '';
    const amount = tds[2]?.textContent || raw.amount || '';
    const original_category = raw.category || '';
    const select = tr.querySelector('select.category-edit');
    const corrected_category = select ? select.value : (localEdits.get(id)?.new_category || original_category);
    const explanation = raw.explanation || (localEdits.get(id)?.explanation || '');
    const edit_timestamp = localEdits.get(id)?.timestamp || '';

    const line = [
      id, description, amount, original_category, corrected_category, explanation, edit_timestamp
    ].map(escapeCellLocal).join(',');

    lines.push(line);
  });

  const csv = lines.join('\r\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'onsitecat_results_with_edits.csv';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); document.body.removeChild(a); }, 1000);
  status.textContent = 'Download started.';
  setTimeout(()=>status.textContent='',1300);
});

/* ---------------------------
  Utilities
---------------------------- */
function safeParse(s){
  try { return s ? JSON.parse(s) : {}; } catch(e){ return {}; }
}

</script>
</body>
</html>
